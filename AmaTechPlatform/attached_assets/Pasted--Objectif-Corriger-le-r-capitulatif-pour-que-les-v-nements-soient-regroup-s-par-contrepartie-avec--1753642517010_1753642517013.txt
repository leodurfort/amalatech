 Objectif
Corriger le rÃ©capitulatif pour que les Ã©vÃ©nements soient regroupÃ©s par contrepartie, avec un affichage clair et lisible.

1. ğŸ§± Backend â€” Express + Drizzle
âœ… Ã‰tendre le GET /projects/:id/roadshow/summary?week=30&year=2025 :
Assure-toi d'inclure le nom de la contrepartie :

ts
Copier
Modifier
const events = await db
  .select({
    counterpartyId: roadshow_event.counterparty_id,
    counterpartyName: roadshow_counterparty.name, // Important
    type: roadshow_event.type,
    date: roadshow_event.date,
    meta: roadshow_event.meta,
  })
  .from(roadshow_event)
  .leftJoin(roadshow_counterparty, eq(roadshow_event.counterparty_id, roadshow_counterparty.id))
  .where(
    and(
      eq(roadshow_counterparty.project_id, projectId),
      between(roadshow_event.date, startOfWeek, endOfWeek)
    )
  );
ğŸŸ¢ Assure-toi que roadshow_counterparty.name existe bien. Utilise alias si besoin.

2. ğŸ–¥ï¸ Frontend â€” Groupement et affichage React
âœ… Regroupement par nom
ts
Copier
Modifier
const grouped = useMemo(() => {
  const result = {};
  events?.forEach((event) => {
    const name = event.counterpartyName || "Contrepartie inconnue";
    if (!result[name]) result[name] = [];
    result[name].push(event);
  });
  return result;
}, [events]);
âœ… Formatage des Ã©vÃ©nements
ts
Copier
Modifier
const formatEvent = (event) => {
  const dateStr = dayjs(event.date).format("DD/MM");
  switch (event.type) {
    case "interaction":
      return `${dateStr} â€” Interaction`;
    case "followup":
      return `${dateStr} â€” Relance`;
    case "teaser":
      return `${dateStr} â€” Envoi teaser`;
    case "nda":
      return `${dateStr} â€” NDA envoyÃ©`;
    case "im":
      return `${dateStr} â€” IM envoyÃ©`;
    case "bp":
      return `${dateStr} â€” BP envoyÃ©`;
    case "ioi":
      return `${dateStr} â€” IOI reÃ§ue`;
    case "meeting":
      return `${dateStr} â€” RÃ©union prÃ©vue`;
    case "extra_send":
      return `${dateStr} â€” Envoi complÃ©mentaire`;
    case "status_change":
      return `${dateStr} â€” Statut changÃ© â†’ ${event.meta?.newStatus ?? "N/A"}`;
    default:
      return `${dateStr} â€” ${event.type}`;
  }
};
âœ… Rendu final
tsx
Copier
Modifier
<div className="space-y-6 mt-6">
  {Object.entries(grouped).map(([name, events]) => (
    <div key={name} className="border p-4 rounded bg-muted/10">
      <h3 className="text-sm font-semibold text-muted-foreground mb-2">
        {name} â€” {events.length} Ã©vÃ©nement{events.length > 1 ? 's' : ''}
      </h3>
      <ul className="list-disc ml-6 text-sm space-y-1">
        {events
          .sort((a, b) => new Date(a.date) - new Date(b.date))
          .map((e, i) => (
            <li key={i}>{formatEvent(e)}</li>
          ))}
      </ul>
    </div>
  ))}
</div>
ğŸ§ª VÃ©rifications
âœ… La requÃªte backend retourne bien counterpartyName

âœ… Les Ã©vÃ©nements sont triÃ©s dans chaque bloc

âœ… Les statuts changÃ©s, relances, IOI, teaser etc. apparaissent bien