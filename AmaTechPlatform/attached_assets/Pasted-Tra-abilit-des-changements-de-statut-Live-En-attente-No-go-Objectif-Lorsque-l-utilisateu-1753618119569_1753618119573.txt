TraÃ§abilitÃ© des changements de statut (Live / En attente / No-go)
ğŸ¯ Objectif :
Lorsque l'utilisateur change le statut d'une contrepartie dans le module Roadshow, un roadshow_event doit Ãªtre crÃ©Ã© avec type: 'status_change'. Ces Ã©vÃ©nements doivent apparaÃ®tre dans le rÃ©capitulatif hebdomadaire.

ğŸ§± 1. Backend â€” PostgreSQL + Drizzle
Table roadshow_event (Ã  Ã©tendre)
ts
Copier
Modifier
// migrations/roadshow_event.ts
import { pgTable, serial, text, date, jsonb, integer } from 'drizzle-orm/pg-core';

export const roadshow_event = pgTable('roadshow_event', {
  id: serial('id').primaryKey(),
  counterparty_id: integer('counterparty_id').notNull(), // FK to roadshow_counterparty.id
  type: text('type').notNull(), // Enum logique cÃ´tÃ© app : 'interaction', 'teaser', ..., 'status_change'
  date: date('date').notNull(),
  meta: jsonb('meta'), // Stocke info comme { newStatus: "Live" }
});
âœ… Si meta existe dÃ©jÃ , ne pas la modifier. Sinon, ajouter cette colonne.

ğŸ§  2. Backend â€” Endpoint Express
CrÃ©er un POST /roadshow/:counterpartyId/status
ts
Copier
Modifier
// routes/roadshow.ts
router.post('/:counterpartyId/status', async (req, res) => {
  const { counterpartyId } = req.params;
  const { newStatus } = req.body;

  if (!['Live', 'En attente', 'No-go'].includes(newStatus)) {
    return res.status(400).json({ error: 'Statut invalide' });
  }

  // update statut dans roadshow_counterparty
  await db.update(roadshow_counterparty)
    .set({ statut: newStatus })
    .where(eq(roadshow_counterparty.id, parseInt(counterpartyId)));

  // enregistrer l'event
  await db.insert(roadshow_event).values({
    counterparty_id: parseInt(counterpartyId),
    type: 'status_change',
    date: new Date(),
    meta: { newStatus },
  });

  res.json({ success: true });
});
ğŸ–¥ï¸ 3. Frontend React
Dans le menu dÃ©roulant de statut (Live / En attente / No-go) :
ts
Copier
Modifier
const handleStatusChange = async (newStatus) => {
  await fetch(`/roadshow/${counterpartyId}/status`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ newStatus }),
  });

  mutate(); // ou refetcher la liste
  toast.success(`Statut mis Ã  jour : ${newStatus}`);
};
ğŸŸ¢ Cela permet de synchroniser le statut visible ET de crÃ©er un event pour la traÃ§abilitÃ©.